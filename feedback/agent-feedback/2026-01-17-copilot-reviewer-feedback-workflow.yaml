agent: kerrigan
date: 2026-01-17
severity: medium
category: process-gap
context:
  task: "Handle Copilot PR reviewer feedback and assign fixes"
  related_prs:
    - 93
    - 94
    - 95
    - 96
    - 97
    - 98
    - 99
    - 100
    - 101
    - 103
  related_files:
    - .github/agents/role.triage.md
    - tools/triage-prs.ps1

observation: |
  The triage role encountered a workflow that isn't documented or tooled: handling
  Copilot pull-request-reviewer feedback. After marking 12 PRs ready for review,
  the copilot-pull-request-reviewer bot automatically reviewed them and left 71
  total comments (ranging from 1-19 per PR).
  
  **Current role guidance:**
  - Section 5 (Agent Management): "Comment to restart Copilot agents when needed"
  - Section 3 (Quality Approval): "Request changes when quality standards aren't met"
  
  But no guidance on:
  - How to detect Copilot PR reviewer has commented
  - How to ensure agents address the review feedback
  - What threshold of comments requires action vs approval
  - Whether to wait for fixes or merge with follow-up issues
  
  **What I did (manual):**
  1. Checked each PR for review comments via gh API
  2. Found 10 PRs with copilot-pull-request-reviewer comments
  3. Added "@copilot Please address all review comments" to each
  4. No tooling support - required custom PowerShell loop
  
  **Gap identified:**
  The role prompt describes reviewing PRs from human/triage perspective but not
  how to orchestrate the agent → review → fix → re-review cycle when Copilot
  reviews its own work.

pattern: |
  **Current state:**
  
  Agent creates PR → Ready for review → Copilot reviewer comments → [GAP] → Merge
  
  The [GAP] is the missing workflow:
  - How to detect review comments exist
  - How to assign agent to fix them
  - When to wait vs when to create follow-up issues
  - How to verify fixes are complete
  
  **Needed workflow:**
  
  1. **Detect Copilot reviews:**
     ```powershell
     # Check for copilot-pull-request-reviewer comments
     gh api /repos/owner/repo/pulls/$pr/comments | 
       Where-Object { $_.user.login -eq "Copilot" }
     ```
  
  2. **Categorize feedback severity:**
     - Critical (tests missing, security issues) → Must fix before merge
     - Important (encoding, imports, best practices) → Should fix
     - Nice-to-have (style suggestions) → Optional or follow-up
  
  3. **Assign fixes:**
     ```powershell
     # If critical or important feedback exists
     gh pr comment $pr --body "@copilot Please address review comments"
     ```
  
  4. **Monitor fix progress:**
     - Check for new commits addressing feedback
     - Re-review after fixes
     - Merge when addressed or create follow-up issues
  
  5. **Handle bulk scenarios:**
     - 12 PRs with 71 comments total
     - Some PRs have 1 comment, others have 19
     - Need efficient batch operations

recommendation: |
  **For Kerrigan (system maintainer):**
  
  1. **Add to role.triage.md:**
     
     New section after "Agent Management":
     
     ```markdown
     ### 5.1. Copilot PR Reviewer Feedback Management
     
     When Copilot pull-request-reviewer leaves feedback:
     
     1. **Detect reviews with feedback:**
        - Check for comments from copilot-pull-request-reviewer
        - Categorize by severity (critical/important/nice-to-have)
     
     2. **Critical feedback (must fix before merge):**
        - Missing functional tests
        - Security vulnerabilities
        - Breaking changes
        → Comment: "@copilot Please address critical review comments"
        → Wait for fixes before approval
     
     3. **Important feedback (should fix):**
        - Missing file encoding
        - Imports in wrong location
        - Unused imports
        - Best practice violations
        → Comment: "@copilot Please address review comments"
        → Verify fixes before approval
     
     4. **Nice-to-have feedback:**
        - Style suggestions
        - Minor optimizations
        → Consider creating follow-up issues instead
        → Don't block PR merge
     
     5. **Bulk feedback handling:**
        - Use tools/handle-reviews.ps1 (see tooling below)
        - Comment on all PRs with feedback
        - Monitor for updates
     ```
  
  2. **Create tools/handle-reviews.ps1:**
     ```powershell
     # Check all PRs for Copilot review feedback
     # Categorize by comment count
     # Optionally assign @copilot to address feedback
     
     ./tools/handle-reviews.ps1                    # Report only
     ./tools/handle-reviews.ps1 --assign-fixes     # Add @copilot comments
     ./tools/handle-reviews.ps1 --threshold 5      # Only PRs with 5+ comments
     ```
  
  3. **Enhance triage-prs.ps1:**
     Add new category to dashboard:
     ```
     [FEEDBACK] PRs with review feedback (N)
     ========================================
       #103: 19 comments from Copilot reviewer
       #94: 18 comments from Copilot reviewer
       #96: 10 comments from Copilot reviewer
       
       Actions:
         ./tools/handle-reviews.ps1 --assign-fixes
     ```
  
  4. **Document in playbooks/pr-review.md:**
     - When Copilot reviews appear
     - How to interpret feedback severity
     - When to wait vs when to create follow-ups
     - Examples of each category
  
  **For Triage agent:**
  - Check for Copilot reviewer comments on all ready PRs
  - Don't approve PRs with critical feedback until addressed
  - For PRs with many comments (>10), create follow-up issues for minor items
  - Comment "@copilot Please address review comments" to assign fixes
  - Re-review after agent pushes updates

evidence: |
  Session handled 10 PRs with Copilot review feedback:
  
  | PR  | Comments | Type                    | Action Taken                      |
  |-----|----------|-------------------------|-----------------------------------|
  | 103 | 19       | CLI implementation      | Assigned @copilot to fix          |
  | 94  | 18       | Design playground       | Assigned @copilot to fix          |
  | 96  | 10       | Interactive refinement  | Assigned @copilot to fix          |
  | 98  | 7        | Multi-repo spec         | Assigned @copilot to fix          |
  | 100 | 6        | Dependency syntax       | Assigned @copilot to fix          |
  | 95  | 5        | Example design system   | Assigned @copilot to fix          |
  | 93  | 3        | Design agent role       | Assigned @copilot to fix          |
  | 97  | 1        | Add label               | Assigned @copilot to fix          |
  | 99  | 1        | CLI architecture        | Assigned @copilot to fix          |
  | 101 | 1        | Prompt URL loading      | Assigned @copilot to fix          |
  
  **Total:** 71 comments across 10 PRs
  
  **Common feedback themes:**
  - Missing functional tests (7 PRs - only testing help text)
  - Missing file encoding='utf-8' (6 PRs)
  - Imports inside functions instead of module level (3 PRs)
  - Unused imports (2 PRs)
  - Hardcoded 'python3' instead of sys.executable (1 PR)
  
  **Manual workflow used:**
  ```powershell
  # Check each PR for comments (manual loop)
  $prs = 92..103
  foreach ($pr in $prs) {
      $comments = gh api "/repos/Kixantrix/kerrigan/pulls/$pr/comments"
      if ($comments.Count -gt 0) {
          gh pr comment $pr --body "@copilot Please address review comments"
      }
  }
  ```
  
  **Time impact:**
  - Manual detection and assignment: ~10 minutes
  - With tooling: ~1 minute
  
  **Quality impact:**
  - Copilot reviewer caught real issues (missing tests, encoding bugs)
  - Feedback improves code quality before merge
  - But process needs to be documented and tooled

impact: medium
actionable: true

# METADATA
status: "implemented"
reviewed_by: "copilot"
reviewed_date: "2026-01-22"
implementation_pr: null
notes: |
  Audited 2026-01-22: IMPLEMENTED
  
  Verified that tools/handle-reviews.ps1 has been created with the functionality
  described in the proposed solution:
  - Detects Copilot PR reviewer comments
  - Shows PRs with review feedback and comment counts
  - Optionally assigns @copilot to address feedback with --AssignFixes flag
  - Supports threshold filtering with --Threshold parameter
  - Includes dry-run mode for testing
  
  The core recommendation has been implemented. Role documentation and playbook
  updates may still be needed but the primary tooling gap is resolved.
