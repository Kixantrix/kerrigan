name: Auto-Ready PR

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  pull-requests: write
  contents: read

jobs:
  mark_ready:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Auto-mark PR ready for review when CI passes
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            
            console.log('üîç CI workflow completed successfully');
            console.log('Workflow run ID:', run.id);
            console.log('Head branch:', run.head_branch);
            
            // Get associated pull requests
            // Two-step search strategy:
            // 1. Try owner:branch format (works for same-repo PRs)
            // 2. Fallback to branch name match (handles forks where owner differs)
            // Note: For PRs from forks, the head format is 'fork-owner:branch-name'
            // For same-repo PRs, the head format is 'repo-owner:branch-name'
            
            let pullRequests = [];
            
            // Try searching with owner:branch format (for same-repo PRs)
            try {
              const ownerBranchRef = `${context.repo.owner}:${run.head_branch}`;
              const { data: samePRs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: ownerBranchRef,
                state: 'open'
              });
              pullRequests = samePRs;
            } catch (error) {
              console.log('‚ö†Ô∏è  Error searching for PRs with owner:branch format:', error.message);
            }
            
            // If no PRs found, try searching all PRs and match by branch name (handles forks)
            if (pullRequests.length === 0) {
              try {
                const { data: allPRs } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open'
                });
                // Match PRs by branch name only (handles forks where owner differs)
                pullRequests = allPRs.filter(pr => pr.head.ref === run.head_branch);
              } catch (error) {
                console.log('‚ö†Ô∏è  Error searching all PRs:', error.message);
              }
            }
            
            if (pullRequests.length === 0) {
              console.log('‚úó No open PRs found for this branch');
              return;
            }
            
            for (const pr of pullRequests) {
              console.log(`\nüìã Processing PR #${pr.number}: ${pr.title}`);
              console.log(`   Draft: ${pr.draft}`);
              console.log(`   State: ${pr.state}`);
              
              // Only mark draft PRs as ready
              if (!pr.draft) {
                console.log('   ‚úì PR is already ready for review - skipping');
                continue;
              }
              
              // Check if PR has agent:go label (indicates autonomous work)
              const prLabels = pr.labels.map(l => l.name);
              const hasAgentGo = prLabels.includes('agent:go');
              
              console.log(`   Agent:go label: ${hasAgentGo ? 'YES' : 'NO'}`);
              
              if (!hasAgentGo) {
                console.log('   ‚úó PR does not have agent:go label - skipping auto-ready');
                continue;
              }
              
              // Mark PR as ready for review
              console.log('   ‚úÖ Marking PR as ready for review');
              
              try {
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  draft: false
                });
                
                console.log('   ‚úÖ PR marked as ready for review');
                
                // Post a comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: `ü§ñ **Automatically marked as ready for review**\n\nCI checks have passed and this PR has the \`agent:go\` label, indicating autonomous work. The PR is now ready for review.\n\nReviewers will be assigned based on role labels if configured.`
                });
                
                console.log('   ‚úÖ Notification comment posted');
              } catch (error) {
                console.log('   ‚ö†Ô∏è  Failed to mark PR as ready:', error.message);
              }
            }
