name: Daily Self-Improvement Analysis

on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      since_days:
        description: 'Analyze feedback from last N days'
        required: false
        type: number
        default: 7
      create_issues:
        description: 'Create GitHub issues for proposals'
        required: false
        type: boolean
        default: false
      enable_web_research:
        description: 'Enable web search for best practices'
        required: false
        type: boolean
        default: false
      enable_github_analysis:
        description: 'Analyze GitHub patterns'
        required: false
        type: boolean
        default: true
      enable_paper_research:
        description: 'Search arXiv for papers'
        required: false
        type: boolean
        default: false
      enable_framework_analysis:
        description: 'Analyze other frameworks'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  issues: write

jobs:
  analyze_and_improve:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Run self-improvement analysis
        id: analysis
        run: |
          SINCE_DAYS="${{ github.event.inputs.since_days || '7' }}"
          
          echo "Running analysis for last ${SINCE_DAYS} days..."
          
          # Build command with optional research flags
          CMD="python tools/self_improvement_analyzer.py \
            --feedback-dir feedback/agent-feedback \
            --docs-dir docs \
            --output self-improvement-report.md \
            --since-days ${SINCE_DAYS} \
            --json-output analysis-results.json"
          
          # Add research flags if enabled
          if [ "${{ github.event.inputs.enable_web_research }}" = "true" ]; then
            CMD="$CMD --enable-web-research"
          fi
          
          if [ "${{ github.event.inputs.enable_github_analysis }}" = "true" ]; then
            CMD="$CMD --enable-github-analysis"
          fi
          
          if [ "${{ github.event.inputs.enable_paper_research }}" = "true" ]; then
            CMD="$CMD --enable-paper-research"
          fi
          
          if [ "${{ github.event.inputs.enable_framework_analysis }}" = "true" ]; then
            CMD="$CMD --enable-framework-analysis"
          fi
          
          # Run the analysis
          eval $CMD
          
          echo "Analysis complete!"
          
          # Extract all metrics using helper script for better readability
          if [ -f analysis-results.json ]; then
            python tools/extract_metrics.py >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload analysis report
        uses: actions/upload-artifact@v4
        with:
          name: self-improvement-report
          path: |
            self-improvement-report.md
            analysis-results.json
          retention-days: 30

      - name: Create improvement proposal issues
        if: github.event.inputs.create_issues == 'true' || github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Load analysis results
            const resultsPath = 'analysis-results.json';
            if (!fs.existsSync(resultsPath)) {
              console.log('‚ùå Analysis results not found');
              return;
            }
            
            const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
            const proposals = results.proposals || [];
            
            console.log(`üìã Processing ${proposals.length} proposals...`);
            
            // Only create issues for high and medium priority proposals
            const issuesToCreate = proposals.filter(p => 
              p.priority === 'high' || p.priority === 'medium'
            );
            
            console.log(`   ${issuesToCreate.length} proposals meet criteria for issue creation`);
            
            let created = 0;
            let skipped = 0;
            
            // Fetch existing issues once to avoid repeated API calls
            let existingIssues = [];
            try {
              const response = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'kerrigan,improvement',
                per_page: 100
              });
              existingIssues = response.data;
              console.log(`   Found ${existingIssues.length} existing improvement issues`);
            } catch (error) {
              console.log(`   ‚ö†Ô∏è  Could not fetch existing issues: ${error.message}`);
            }
            
            for (const proposal of issuesToCreate) {
              // Check if similar issue already exists with more precise matching
              const normalizedTitle = proposal.title.toLowerCase().trim();
              const alreadyExists = existingIssues.some(issue => {
                if (!issue.title) return false;
                const existingTitle = issue.title.toLowerCase().trim();
                // Exact match or very high similarity (>80% of words match)
                if (existingTitle === normalizedTitle) return true;
                
                const words1 = new Set(normalizedTitle.split(/\s+/));
                const words2 = new Set(existingTitle.split(/\s+/));
                const intersection = new Set([...words1].filter(w => words2.has(w)));
                const similarity = intersection.size / Math.max(words1.size, words2.size);
                return similarity > 0.8;
              });
              
              if (alreadyExists) {
                console.log(`   ‚è≠Ô∏è  Similar issue exists: "${proposal.title}"`);
                skipped++;
                continue;
              }
              
              // Create the issue
              const issueBody = [
                '## Description',
                '',
                proposal.description,
                '',
                '## Evidence',
                '',
                proposal.evidence,
                '',
                '## Proposed Solution',
                '',
                proposal.proposed_solution,
                '',
                '---',
                '',
                `**Type**: ${proposal.type}`,
                `**Priority**: ${proposal.priority}`,
                `**Category**: ${proposal.category}`,
                '',
                '*This issue was automatically generated by the daily self-improvement workflow.*',
                '',
                `**Analysis Date**: ${new Date().toISOString().split('T')[0]}`
              ].join('\n');
              
              try {
                const newIssue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: proposal.title,
                  body: issueBody,
                  labels: proposal.labels || ['kerrigan', 'improvement']
                });
                
                console.log(`   ‚úÖ Created issue #${newIssue.data.number}: ${proposal.title}`);
                created++;
                
                // Rate limit: wait a bit between issue creations
                await new Promise(resolve => setTimeout(resolve, 1000));
                
              } catch (error) {
                console.log(`   ‚ùå Failed to create issue: ${error.message}`);
              }
            }
            
            console.log(`\nüìä Summary:`);
            console.log(`   Created: ${created} issues`);
            console.log(`   Skipped: ${skipped} (similar issues exist)`);

      - name: Create daily summary issue
        if: github.event.inputs.create_issues == 'true' || github.event_name == 'schedule'
        uses: actions/github-script@v7
        env:
          FEEDBACK_COUNT: ${{ steps.analysis.outputs.feedback_count || 'N/A' }}
          PATTERNS_COUNT: ${{ steps.analysis.outputs.patterns_count || 'N/A' }}
          PROPOSALS_COUNT: ${{ steps.analysis.outputs.proposals_count || 'N/A' }}
          HIGH_PRIORITY: ${{ steps.analysis.outputs.high_priority || '0' }}
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toISOString().split('T')[0];
            
            // Load analysis results
            const resultsPath = 'analysis-results.json';
            if (!fs.existsSync(resultsPath)) {
              console.log('‚ùå Analysis results not found, skipping summary issue');
              return;
            }
            
            const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
            const proposals = results.proposals || [];
            
            // Build list of created issues
            const highMediumProposals = proposals.filter(p => 
              p.priority === 'high' || p.priority === 'medium'
            );
            
            const issuesList = highMediumProposals.length > 0
              ? highMediumProposals.map(p => `- ${p.title} (${p.priority})`).join('\n')
              : 'No new issues created (low priority proposals only)';
            
            const body = `## Self-Improvement Analysis for ${date}
            
            ### Metrics
            - **Feedback processed**: ${process.env.FEEDBACK_COUNT}
            - **Patterns found**: ${process.env.PATTERNS_COUNT}
            - **Proposals generated**: ${process.env.PROPOSALS_COUNT}
            - **High priority**: ${process.env.HIGH_PRIORITY}
            
            ### Issues Created
            ${issuesList}
            
            ### Full Report
            üìé [Download full analysis report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            The complete report with all proposals, evidence, and pattern analysis is available in the workflow artifacts (30-day retention).
            
            ---
            *Automated by daily-self-improvement workflow*`;
            
            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Daily Analysis Summary ${date}`,
                body: body,
                labels: ['kerrigan', 'meta', 'daily-summary']
              });
              console.log(`‚úÖ Created daily summary issue`);
            } catch (error) {
              console.log(`‚ùå Failed to create summary issue: ${error.message}`);
            }

      - name: Post summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Load report if it exists
            let reportPreview = '';
            if (fs.existsSync('self-improvement-report.md')) {
              const report = fs.readFileSync('self-improvement-report.md', 'utf8');
              const lines = report.split('\n');
              const previewLines = lines.slice(0, 30);
              reportPreview = previewLines.join('\n') + '\n\n...';
            }
            
            const summary = [
              '# ü§ñ Kerrigan Self-Improvement Analysis',
              '',
              '## Metrics',
              '',
              `- **Feedback processed**: ${{ steps.analysis.outputs.feedback_count || 'N/A' }}`,
              `- **Patterns found**: ${{ steps.analysis.outputs.patterns_count || 'N/A' }}`,
              `- **Proposals generated**: ${{ steps.analysis.outputs.proposals_count || 'N/A' }}`,
              `- **High priority**: ${{ steps.analysis.outputs.high_priority || 'N/A' }}`,
              `- **External findings**: ${{ steps.analysis.outputs.external_findings || '0' }}`,
              '',
              '## Report Preview',
              '',
              '```markdown',
              reportPreview,
              '```',
              '',
              'üìé Full report available in workflow artifacts',
              ''
            ].join('\n');
            
            await core.summary
              .addRaw(summary)
              .write();
            
            console.log('‚úÖ Summary posted to workflow');

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            console.log('‚ùå Self-improvement analysis failed');
            console.log('Check workflow logs for details');
            
            await core.summary
              .addRaw('# ‚ùå Self-Improvement Analysis Failed\n\nCheck workflow logs for details.')
              .write();
