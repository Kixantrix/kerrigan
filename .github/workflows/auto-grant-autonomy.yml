name: Auto-Grant Autonomy

on:
  issues:
    types: [opened, labeled]

# Prevent duplicate runs when issue is opened with labels
concurrency:
  group: auto-grant-${{ github.event.issue.number }}
  cancel-in-progress: true

permissions:
  issues: write
  contents: read

jobs:
  auto_grant:
    runs-on: ubuntu-latest
    # Skip if this is a 'labeled' event for agent:go (we add it ourselves)
    if: ${{ !(github.event.action == 'labeled' && github.event.label.name == 'agent:go') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auto-apply agent:go label and assign Copilot
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const issueLabels = issue.labels.map(l => l.name);
            
            console.log('üîç Checking if issue #' + issue.number + ' should get agent:go label');
            console.log('Event action:', context.payload.action);
            console.log('Issue Labels:', issueLabels.join(', ') || '(none)');
            console.log('Issue Author:', issue.user.login);
            
            // Skip if already has agent:go or agent:sprint
            if (issueLabels.includes('agent:go') || issueLabels.includes('agent:sprint')) {
              console.log('‚úì Issue already has autonomy grant - skipping');
              return;
            }
            
            // Load configuration
            const fs = require('fs');
            let config;
            try {
              const configPath = '.github/automation/reviewers.json';
              const configContent = fs.readFileSync(configPath, 'utf8');
              config = JSON.parse(configContent);
            } catch (error) {
              console.log('‚ö†Ô∏è  Could not load reviewers.json config:', error.message);
              console.log('Skipping auto-grant');
              return;
            }
            
            // Check if auto-grant is enabled (default to false for safety)
            if (!config.auto_grant_autonomy) {
              console.log('‚ÑπÔ∏è  Auto-grant autonomy is disabled in config');
              return;
            }
            
            // Define criteria for auto-granting agent:go
            let shouldGrant = false;
            let reasons = [];
            
            // Criterion 1: Issue has role label
            const roleLabels = ['role:spec', 'role:architect', 'role:swe', 'role:testing', 
                              'role:security', 'role:deployment', 'role:debugging', 'role:design'];
            const hasRoleLabel = issueLabels.some(label => roleLabels.includes(label));
            
            if (hasRoleLabel) {
              shouldGrant = true;
              reasons.push('Issue has role label (auto-triaged)');
            }
            
            // Criterion 2: Issue created by trusted user (if configured)
            const trustedUsers = config.trusted_users || [];
            if (trustedUsers.includes(issue.user.login)) {
              shouldGrant = true;
              reasons.push('Issue created by trusted user: ' + issue.user.login);
            }
            
            // Criterion 3: Issue has kerrigan label (project-related)
            if (issueLabels.includes('kerrigan')) {
              shouldGrant = true;
              reasons.push('Issue has kerrigan project label');
            }
            
            // Criterion 4: Issue has tier:auto label
            if (issueLabels.includes('tier:auto')) {
              shouldGrant = true;
              reasons.push('Issue has tier:auto label (no gates required)');
            }
            
            if (!shouldGrant) {
              console.log('‚úó Issue does not meet criteria for auto-grant');
              console.log('Criteria checked:');
              console.log('  - Role labels:', hasRoleLabel ? 'YES' : 'no');
              console.log('  - Trusted user:', trustedUsers.includes(issue.user.login) ? 'YES' : 'no');
              console.log('  - Kerrigan label:', issueLabels.includes('kerrigan') ? 'YES' : 'no');
              console.log('  - Tier auto:', issueLabels.includes('tier:auto') ? 'YES' : 'no');
              return;
            }
            
            // Grant autonomy - use most specific reason
            const reason = reasons.join('; ');
            console.log(`‚úÖ Granting autonomy: ${reason}`);
            
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['agent:go']
              });
              
              console.log('‚úÖ Added agent:go label');
              
              const defaultBranch = context.payload.repository?.default_branch || 'main';
              
              // Post comment if configured
              if (config.comment_on_auto_grant) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `ü§ñ **Autonomy granted automatically**\n\nReason: ${reason}\n\nThis issue now has the \`agent:go\` label, allowing agents to work on it autonomously. See the [Autonomy Modes playbook](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/${defaultBranch}/playbooks/autonomy-modes.md) for details.`
                });
              }
              
              // Also assign Copilot directly (workflow-added labels don't trigger other workflows)
              const currentAssignees = issue.assignees.map(a => a.login);
              if (!currentAssignees.includes('copilot')) {
                console.log('‚úÖ Assigning Copilot to issue');
                try {
                  await github.rest.issues.addAssignees({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    assignees: ['copilot']
                  });
                  console.log('‚úÖ Copilot assigned successfully');
                  
                  // Post a notification comment for Copilot
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: `@copilot This issue has been granted autonomy with the \`agent:go\` label. You may begin work on this issue.\n\nSee the [Autonomy Modes playbook](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/${defaultBranch}/playbooks/autonomy-modes.md) for details on autonomous workflow.`
                  });
                  console.log('‚úÖ Copilot notification posted');
                } catch (assignError) {
                  console.log('‚ö†Ô∏è  Failed to assign Copilot:', assignError.message);
                  console.log('Note: Copilot must be a valid user with repository access');
                }
              } else {
                console.log('‚úì Copilot is already assigned - skipping');
              }
            } catch (error) {
              console.log('‚ö†Ô∏è  Failed to add agent:go label:', error.message);
            }
