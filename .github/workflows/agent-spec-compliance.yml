name: Agent Spec Compliance

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    paths:
      - '.github/agents/**'
      - 'specs/kerrigan/agents/**'
      - 'tools/agent_audit.py'

permissions:
  contents: read
  pull-requests: read

jobs:
  check-spec-references:
    name: Verify Agent Prompts Reference Specs
    runs-on: ubuntu-latest
    if: |
      contains(github.event.pull_request.changed_files, '.github/agents/') ||
      contains(join(github.event.pull_request.labels.*.name, ','), 'agent:prompt-update')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check spec references
        run: |
          echo "üîç Checking if agent prompts reference their specifications..."
          python tools/agent_audit.py check-spec-references
        
      - name: Compliance check passed
        if: success()
        run: |
          echo "‚úÖ All agent prompts properly reference their specifications"

  check-agent-pr-compliance:
    name: Validate Agent PR Compliance
    runs-on: ubuntu-latest
    if: |
      contains(join(github.event.pull_request.labels.*.name, ','), 'role:') ||
      contains(join(github.event.pull_request.labels.*.name, ','), 'agent:')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check agent signature
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            const prLabels = context.payload.pull_request.labels.map(l => l.name);
            
            console.log('üîç Checking agent signature in PR description...');
            console.log(`PR #${context.payload.pull_request.number}: ${context.payload.pull_request.title}`);
            console.log(`Labels: ${prLabels.join(', ')}`);
            
            // Extract agent/role labels
            const agentLabels = prLabels.filter(l => l.startsWith('role:') || l.startsWith('agent:'));
            
            if (agentLabels.length === 0) {
              console.log('‚ÑπÔ∏è  No role: or agent: labels found - skipping compliance check');
              return;
            }
            
            console.log(`Agent labels: ${agentLabels.join(', ')}`);
            
            // Check for agent signature pattern
            const signaturePattern = /<!--\s*AGENT_SIGNATURE:\s*role=([^,]+),\s*version=([^,]+),\s*timestamp=([^\s]+)\s*-->/;
            const match = prBody.match(signaturePattern);
            
            if (!match) {
              console.log('‚ö†Ô∏è  No agent signature found in PR description');
              console.log('');
              console.log('Agent-labeled PRs should include a signature for auditability.');
              console.log('');
              console.log('To add a signature, run:');
              console.log('  python tools/agent_audit.py create-signature <role>');
              console.log('');
              console.log('Example output:');
              console.log('  <!-- AGENT_SIGNATURE: role=role:swe, version=1.0, timestamp=2026-01-15T06:00:00Z -->');
              console.log('');
              console.log('See docs/agent-spec-validation.md for details.');
              console.log('');
              console.log('This is informational only - PR can still be merged.');
              return;
            }
            
            const [_, role, version, timestamp] = match;
            console.log('‚úÖ Agent signature found');
            console.log(`   Role: ${role}`);
            console.log(`   Version: ${version}`);
            console.log(`   Timestamp: ${timestamp}`);
            
            // Check if signature role matches labels
            if (!agentLabels.includes(role)) {
              console.log('');
              console.log(`‚ö†Ô∏è  Warning: Signature role '${role}' doesn't match PR labels`);
              console.log(`   PR labels: ${agentLabels.join(', ')}`);
              console.log('   Consider updating the signature or labels to match');
              console.log('');
              console.log('This is informational only - PR can still be merged.');
            }

      - name: Validate spec compliance
        run: |
          echo "üîç Validating agent spec compliance..."
          
          # Extract role from PR labels (use first role: label found)
          LABELS="${{ join(github.event.pull_request.labels.*.name, ' ') }}"
          ROLE=""
          
          for label in $LABELS; do
            if [[ $label == role:* ]]; then
              ROLE=$label
              break
            fi
          done
          
          if [ -z "$ROLE" ]; then
            echo "‚ÑπÔ∏è  No role: label found - skipping compliance validation"
            echo "   (Only validating PRs with explicit role labels)"
            exit 0
          fi
          
          echo "   Checking compliance for: $ROLE"
          
          # Save PR body to temp file for validation
          cat > /tmp/pr_body.txt << 'EOF'
          ${{ github.event.pull_request.body }}
          EOF
          
          # Run compliance validation
          python tools/agent_audit.py validate-compliance "$ROLE" /tmp/pr_body.txt || {
            echo ""
            echo "‚ùå Spec compliance validation failed"
            echo ""
            echo "This PR may not be following the agent's specification."
            echo "See docs/agent-spec-validation.md for compliance requirements."
            echo ""
            echo "Common issues:"
            echo "  - Missing or invalid agent signature"
            echo "  - Agent prompt doesn't reference specification files"
            echo "  - Signature role doesn't match expected role"
            echo ""
            echo "This is treated as a warning - PR can still be merged with human approval."
            exit 0
          }
          
          echo "‚úÖ Agent is compliant with specification"
